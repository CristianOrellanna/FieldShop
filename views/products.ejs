<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--icon-->
    <link rel="shortcut icon" href="https://i.ibb.co/fkhvBg0/retail.png" />
        <!--CSS-->
        <link rel="stylesheet" href="resources/css/style.css">
        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <title>Productos-Fieldshop</title>
</head>
<body>
      <!--navbar-->
      <div class="container">
        <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <span class="logo">FieldShop</span>
            </a>
    
            <div style="flex-grow: 1; display: flex; justify-content: center;">
                <ul class="nav nav-pills">
                    <li><a href="/" class="nav-link px-2 link-secondary">Inicio</a></li>
                    <li><a href="/products" class="nav-link px-2 link-secondary">Productos</a></li>
                    <li><a href="/us" class="nav-link px-2 link-secondary">Nosotros</a></li>
                    <li><a href="/contact" class="nav-link px-2 link-secondary">Contacto</a></li>
                </ul>
            </div>
    
            <!--
            <button type="button" class="btn btn-outline-dark me-2" style="width: 150px; height: 38px; margin-right: 5px;" onclick="location.href='/login';">Iniciar sesion</button>
            -->
            <button type="button" class="btn btn-outline-dark" style="width: 150px; height: 38px; margin-right: 5px;" onclick="location.href='/register';">Registrarse</button>
    
            <div class="dropdown">
                <button class="btn btn-dark dropdown-toggle" type="button" style="width: 150px; height: 38px;" data-bs-toggle="dropdown" aria-expanded="false">
                    <% if (login) { %>                
                        <p><%= name %></p>
                    <%} else { %>
                        <p><%= name %></p>
                    <% } %>
                </button>
                <ul class="dropdown-menu">
                    <% if (login) { %>       
                        <li><a class="dropdown-item" href="logout">Cerrar sesión</a></li>
                        <!--se crea el boton(de manera invisible) para que el usuario pueda comprar solo si ha iniciado sesion-->
                        <button class="invisible-button" onclick="comprar()"></button>
                    <%} else { %>
                        <li><a class="dropdown-item" href="login">Ir a login</a></li>
                    <% } %>
                </ul>
            </div>
          </header>
      </div>

      <!--Products list-->
      <h2 class="text-center Tittle-Home">Productos</h2>
      <div id="productos"></div>
      
      <h2 class="text-center Tittle-Home">Carrito</h2>
      <div id="carrito"></div>
      
      <h2 class="text-center Tittle-Home">Total</h2>
      <div id="total"></div>
      

        <!-- si el usuario inicia sesion puede comprar, del contrario se le redirecciona al login -->
        <div class="d-flex justify-content-center" id="botonCompra">
            <% if (login) { %>
                <button onclick="comprar()" class="btn btn-dark">Comprar</button>
            <% } else { %>
                <button onclick="location.href='/login';" class="btn btn-dark">Inicia sesión aquí para poder realizar la compra</button>
            <% } %>
        </div>
        
    
      <!--Carrito de compras con productos almacenados en un array-->
      <script>
            var productos = [
                { nombre: 'Arroz grado 1 grano largo y ancho 1 kg', precio: 2429, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/655914-450-450?width=450&height=450&aspect=true'},
                { nombre: 'Arroz grado 2 gran selección grano largo y ancho 1 kg', precio: 1829, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/459006-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Arroz Grado 2 Grano Largo y Laminado 1 kg', precio: 1589, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/453196-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Arroz Grado 1 Grano Largo y Ancho 1 kg', precio: 1899, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/638211-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Pasta Spaghetti N°5 400 g', precio: 1139, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/453113-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Pasta Espiral N°49 400 g', precio: 1139, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/453080-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Espirales al huevo 400 g', precio: 1289, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/680242-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Espirales Tr3s 400 g', precio: 1139, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/680377-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Pack 3 un. Bebidas Coca Cola + Sprite 3 L', precio: 8299, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/501515-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Bebida Canada Dry Ginger Ale 3 L', precio: 2799, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/412055-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Bebida Sprite 3 L', precio: 3099, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/643750-450-450?width=450&height=450&aspect=true' },
                { nombre: 'Bebida Coca-Cola Original 3 L', precio: 3099, imagen: 'https://jumbo.vtexassets.com/arquivos/ids/655907-450-450?width=450&height=450&aspect=true' }
            ];

            var carrito = [];

            /**
             * Muestra los productos en la página web.
             * Cada producto se muestra en una tarjeta con su imagen, nombre y precio.
             * Incluye un botón para agregar el producto al carrito de compras.
             */
            function mostrarProductos() {
                var productosDiv = document.getElementById('productos');  
                productosDiv.innerHTML = '';
                productosDiv.className = 'd-flex justify-content-center align-items-center flex-wrap';               
                productos.forEach(function(producto, index) {
                    var productoDiv = document.createElement('div');
                    productoDiv.className = 'card m-3';
                    productoDiv.style = 'width: 18rem;';       
                    productoDiv.innerHTML = 
                        '<img src="' + producto.imagen + '" class="card-img-top" alt="' + producto.nombre + '">' +
                        '<div class="card-body text-center">' +
                            '<h5 class="card-title">' + producto.nombre + '</h5>' +
                            '<p class="card-text">Precio: $' + producto.precio + '</p>' +
                            '<button class="btn btn-warning" onclick="agregarAlCarrito(' + index + ')">Agregar al carrito</button>' +
                        '</div>';
                    productosDiv.appendChild(productoDiv);
                });
            }

            //Agrega el producto al carrito
            function agregarAlCarrito(index) {
                var producto = productos[index];
                // Busca el producto en el carrito para ver si ya existe.
                var productoEnCarrito = carrito.find(p => p.nombre === producto.nombre);
                if (productoEnCarrito) {
                    productoEnCarrito.cantidad++;
                } else {
                    producto.cantidad = 1;
                    carrito.push(producto);
                }
                mostrarCarrito();
                calcularTotal();
            }
      
            //Elimina el producto del carrito
            function eliminarDelCarrito(index) {
                carrito.splice(index, 1);
                mostrarCarrito();
                calcularTotal();
            }
        
            //Si se agrega, modifica la cantidad o se elimina un producto del carrito, esta funcion lo actualiza
            function actualizarCantidad(index, cantidad) {
                carrito[index].cantidad = cantidad;
                mostrarCarrito();
                calcularTotal();
            }
      
            //Muestra el carrito con los productos agregados o vacio si no contiene productos
            function mostrarCarrito() {
                var carritoDiv = document.getElementById('carrito');
                carritoDiv.innerHTML = '';
                carritoDiv.className = 'd-flex justify-content-center align-items-center flex-wrap';
                carrito.forEach(function(producto, index) {
                    var productoDiv = document.createElement('div');
                    productoDiv.className = 'card m-3';
                    productoDiv.style = 'width: 18rem;';
                    productoDiv.innerHTML = 
                        '<img src="' + producto.imagen + '" class="card-img-top" alt="' + producto.nombre + '">' +
                        '<div class="card-body">' +
                            '<h5 class="card-title">' + producto.nombre + '</h5>' +
                            '<p class="card-text">Precio: ' + producto.precio + '</p>' +
                            '<input type="number" class="form-control" value="' + producto.cantidad + '" min="1" onchange="actualizarCantidad(' + index + ', this.value)" />' +
                            '<button class="btn btn-danger mt-2" onclick="eliminarDelCarrito(' + index + ')">Eliminar del carrito</button>' +
                        '</div>';
                    carritoDiv.appendChild(productoDiv);
                });
            }


            //Calcula el total del precio de los productos en el carrito
            function calcularTotal() {
                var total = 0;
                carrito.forEach(function(producto) {
                    total += producto.precio * producto.cantidad;
                });

                var totalDiv = document.getElementById('total');
                totalDiv.innerHTML = '<h5 class="text-center">Total a pagar: $' + total + '</h5>';
            }

            mostrarCarrito();
            calcularTotal();

            function comprar() {
                if (carrito.length > 0) {
                    // Busca el formulario existente
                    var formulario = document.getElementById('formularioCompra');

                    // Si el formulario no existe, lo crea
                    if (!formulario) {
                        formulario = document.createElement('form');
                        formulario.id = 'formularioCompra';
                        document.body.appendChild(formulario);
                    }

                    // Limpia el formulario
                    formulario.innerHTML = '';

                    // Añade los campos al formulario
                    formulario.innerHTML = `
                    <div class="container">
                    <form style="max-width: 400px;" class="mx-auto">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre:</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" value="<%= name %>">
                        </div>
                        <div class="mb-3">
                            <label for="ciudad" class="form-label">Ciudad:</label>
                            <input type="text" class="form-control" id="ciudad" name="ciudad">
                        </div>
                        <div class="mb-3">
                            <label for="direccion" class="form-label">Dirección:</label>
                            <input type="text" class="form-control" id="direccion" name="direccion">
                        </div>
                        <div class="mb-3">
                            <label for="correo" class="form-label">Correo:</label>
                            <input type="email" class="form-control" id="correo" name="correo">
                        </div>
                        <div class="text-center">
                        <h3>Productos a enviar:</h3>
                        <ul id="listaProductos" class="list-group mb-3 mx-auto" style="list-style-type: none;"></ul>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                    </div>
                    `;

                    // Añade los productos del carrito a la lista
                    var listaProductos = document.getElementById('listaProductos');
                    carrito.forEach(function(producto) {
                        var productoLi = document.createElement('li');
                        productoLi.textContent = producto.nombre + ' - $' + producto.precio + ' Cantidad: ' + producto.cantidad;
                        listaProductos.appendChild(productoLi);
                    });
                    // Encuentra el div llamado:"botonCompra" en el html y añade el formulario debajo de este
                    var divCompra = document.getElementById('botonCompra');
                    divCompra.parentNode.insertBefore(formulario, divCompra.nextSibling);
                    // alert('Compra realizada con éxito!');
                    carrito = []; // Vacía el carrito
                    mostrarCarrito();
                    calcularTotal();
                } else {
                    alert('Tu carrito está vacío');
                }
            }



          mostrarProductos();
      </script>
      

      <!--footer-->
            <footer class="py-3 my-4" style="background-color: #2c2c2c; color: white; width: 100%;">
              <ul class="nav justify-content-center border-bottom pb-3 mb-3">
                <li class="nav-item"><a href="/" class="nav-link px-2 text-white">Inicio</a></li>
                <li class="nav-item"><a href="/products" class="nav-link px-2 text-white">Productos</a></li>
                <li class="nav-item"><a href="/us" class="nav-link px-2 text-white">Nosotros</a></li>
                <li class="nav-item"><a href="/contact" class="nav-link px-2 text-white">Contacto</a></li>
              </ul>
              <p class="text-center text-white">© 2024 Fieldshop, Inc</p>
            </footer>
</body>
</html>